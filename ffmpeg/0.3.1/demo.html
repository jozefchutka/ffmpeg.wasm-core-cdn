<body>
<video autoplay controls></video>
<p>Watch console log.</p>
<script>
(async () => {

if(typeof SharedArrayBuffer === "undefined")
	return document.body.innerHTML = "SharedArrayBuffer is not available. Run <code style='background:#ccc'>chrome --enable-features=SharedArrayBuffer</code> or follow <a href='https://web.dev/cross-origin-isolation-guide/'>A guide to enable cross-origin isolation</a>.";

const wasmGZ = await (await fetch("ffmpeg.wasm.gz")).blob();
const wasmBlob = await new Response(wasmGZ.stream().pipeThrough(new DecompressionStream("gzip"))).blob();
const wasmUrl = URL.createObjectURL(new Blob([wasmBlob], {type:"application/wasm"}));
const ffmpegUrl = URL.createObjectURL(await (await fetch("ffmpeg.js")).blob());
const ffmpegWorkerUrl = URL.createObjectURL(await (await fetch("ffmpeg.worker.js")).blob());
const args = ["-filter_complex", "smptehdbars=size=320x240:rate=30000/1001;sine=frequency=440:sample_rate=48000:beep_factor=2", "-t", "5", "out.mp4"];

const worker = new Worker(URL.createObjectURL(new Blob([`
	self.addEventListener("message", async (event) => {
		const {args, wasmUrl, ffmpegUrl, ffmpegWorkerUrl} = event.data;
		importScripts(ffmpegUrl);
		const module = await createFFmpeg({
			printErr:console.log,
			locateFile:path => {
				if(path === "ffmpeg.wasm") return wasmUrl;
				if(path === "ffmpeg.worker.js") return ffmpegWorkerUrl;
				return path;},
			mainScriptUrlOrBlob:ffmpegUrl});
		module.onExit = () => {
			const content = module.FS.readFile("out.mp4");
			self.postMessage(content.buffer, [content.buffer])
		}
		module.callMain(args);
	});
`])));
worker.onmessage = event => {
	const video = document.querySelector("video");
	const blob = new Blob([new Uint8Array(event.data)]);
	video.src = URL.createObjectURL(blob);
	worker.terminate();
}
worker.postMessage({args, wasmUrl, ffmpegUrl, ffmpegWorkerUrl});

})()
</script>
</body>