<body>
<video autoplay controls></video>
<p>Watch console log.</p>
<script id="worker" type="javascript/worker">

// workaround for safari

if(!("Worker" in self)) {
	class Worker extends EventTarget {
		static id = 0;
		static subworkers = new Map();
		constructor(url) {
			super();
			this.id = Worker.id++;
			self.postMessage({kind:"subworker", id:this.id, cmd:"create", url});
			Worker.subworkers.set(this.id, this);
		}
		
		postMessage(data) {
			self.postMessage({kind:"subworker", id:this.id, cmd:"postMessage", data});
		}
		
		terminate() {
			self.postMessage({kind:"subworker", id:this.id, cmd:"terminate"});
			Worker.subworkers.delete(this.id);
		}
	}
	self.Worker = Worker;
}

self.addEventListener("message", async (event) => {
	const data = event.data;
	if(data.kind === "subworker" && data.cmd === "event")
		return Worker.subworkers.get(data.id).onmessage(new MessageEvent(data.type, {data:data.data}));

	const {args, wasmUrl, ffmpegUrl, ffmpegWorkerUrl} = event.data;
	importScripts(ffmpegUrl);
	const module = await createFFmpeg({
		printErr:console.log,
		locateFile:path => {
			if(path === "ffmpeg.wasm") return wasmUrl;
			if(path === "ffmpeg.worker.js") return ffmpegWorkerUrl;
			return path;},
		mainScriptUrlOrBlob:ffmpegUrl});
	module.onExit = () => {
		const content = module.FS.readFile("out.mp4");
		self.postMessage(new Blob([content.buffer], {type:"video/mp4"}));
	}
	module.callMain(args);
	console.log(Worker);
});
</script>
<script>
(async () => {

if(typeof SharedArrayBuffer === "undefined")
	return document.body.innerHTML = "SharedArrayBuffer is not available. Run <code style='background:#ccc'>chrome --enable-features=SharedArrayBuffer</code> or follow <a href='https://web.dev/cross-origin-isolation-guide/'>A guide to enable cross-origin isolation</a>.";

const wasmUrl = new URL("ffmpeg.wasm", document.location).href;
const ffmpegUrl = new URL("ffmpeg.js", document.location).href;
const ffmpegWorkerUrl = new URL("ffmpeg.worker.js", document.location).href;
//const args = ["-filter_complex", "smptehdbars=size=320x240:rate=30000/1001;sine=frequency=440:sample_rate=48000:beep_factor=2", "-c:v", "libopenh264", "-t", "5", "out.mp4"];
const args = ["-filter_complex", "smptehdbars=size=320x240:rate=30000/1001;sine=frequency=440:sample_rate=48000:beep_factor=2",
	"-c:v", "libopenh264", "-pix_fmt:v", "yuv420p", "-profile:v", "high",
	"-c:a", "aac", "-ac", "2",
	"-t", "5", "out.mp4", "-movflags", "+faststart"];

//ffmpeg -hide_banner -filter_complex "smptehdbars=size=400x120:rate=60,drawtext=fontfile=c\\:/Windows/Fonts/arial.ttf:timecode=00\\:00\\:00.00:rate=60:fontsize=72:fontcolor=white:x=(w-tw)/2:y=(h-th)/2:box=1:boxcolor=0x00000000@1;sine=frequency=440:sample_rate=48000:beep_factor=2" -t 60 -c:v libx264 -pix_fmt:v yuv420p -crf:v 23 -profile:v high -preset:v veryslow -c:a aac -ac 2 -f mp4 -movflags +faststart -y bars_h264_400x120_60fps_aac_stereo_60s_1MB.mp4


const workerBlob = new Blob([document.querySelector('#worker').textContent], {type:"text/javascript"});
const worker = new Worker(URL.createObjectURL(workerBlob));
const subworkers = new Map();

worker.onmessage = event => {
	const data = event.data;
	
	// workaround for safari
	if(data.kind === "subworker") {
		const {cmd, id, url} = data;
		switch(cmd) {
			case "create":
				const subworker = new Worker(url);
				subworker.onmessage = event =>
					worker.postMessage({kind:"subworker", cmd:"event", id, type:event.type, data:event.data});
				subworkers.set(id, subworker);
				break;
			case "postMessage":
				subworkers.get(id).postMessage(data.data);
				break;
			case "terminate":
				subworkers.get(id).terminate();
				subworkers.delete(id);
			
		}
		return;
	}
	
	const video = document.querySelector("video");
	console.log(event.data);
	video.src = URL.createObjectURL(event.data);
	worker.terminate();
}
worker.postMessage({args, wasmUrl, ffmpegUrl, ffmpegWorkerUrl});

})()
</script>
</body>